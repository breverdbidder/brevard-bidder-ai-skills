# BrevardBidderAI Skills System - Daily Analysis
# Runs daily at 2 AM EST to check documentation threshold

name: Daily Analysis Check

on:
  schedule:
    # 2 AM EST = 7 AM UTC
    - cron: '0 7 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  ANALYSIS_THRESHOLD: '10'

jobs:
  check-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check documentation threshold
        id: check
        run: |
          python -c "
          import os
          import sys
          sys.path.insert(0, 'scripts')
          from utils.supabase_client import get_client
          
          client = get_client()
          pending = client.count_unanalyzed_tasks()
          threshold = int(os.getenv('ANALYSIS_THRESHOLD', '10'))
          
          print(f'Pending tasks: {pending}')
          print(f'Threshold: {threshold}')
          
          if pending >= threshold:
              print('::set-output name=ready::true')
              print('READY FOR ANALYSIS')
          else:
              print('::set-output name=ready::false')
              print(f'Need {threshold - pending} more tasks')
          "
      
      - name: Generate analysis prompt
        if: steps.check.outputs.ready == 'true'
        run: |
          python scripts/core/orchestrator.py --analyze
      
      - name: Upload analysis prompt
        if: steps.check.outputs.ready == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: analysis-prompt
          path: prompts/generated/
          retention-days: 30
      
      - name: Generate status report
        run: |
          python scripts/core/orchestrator.py --status
      
      - name: Log system event
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'scripts')
          from utils.supabase_client import get_client
          from datetime import datetime
          
          client = get_client()
          overview = client.get_system_overview()
          client.log_system_event('daily_check', {
              'timestamp': datetime.now().isoformat(),
              'pending_tasks': overview['pending_analysis'],
              'total_skills': overview['total_skills'],
              'workflow': 'daily_analysis'
          })
          "
